@{
    ViewData["Title"] = "Trip Planner";
    Layout = "_Layout";
}

<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=places&key=YOUR_API_KEY_HERE"></script>
</head>
<body>
    
    @using (Html.BeginForm("Map", "TripPlanner", FormMethod.Post))
    {
        <table border="0" cellpadding="5" cellspacing="0">
            <tr>
                <td>Start Location</td>
                <td>@Html.TextBox("startLocation")</td>
            </tr>
            <!--          <tr>
                <td>End Location</td>
                <td>@Html.TextBox("endLocation")</td>
            </tr> -->
        </table>
    }

<div id="map" style="width:100%;height:400px;"></div>

    <script type="text/javascript">
        let geocoder;
        function InitializeMap() {
            // Set the Latitude and Longitude of the Map
            var myAddress = new google.maps.LatLng(39.9526, -75.1652);

            // Create Options or set different Characteristics of Google Map
            var mapOptions = {
                center: myAddress,
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            // Display the Google map in the div control with the defined Options
            var map = new google.maps.Map(document.getElementById("map"), mapOptions);
            // Set Marker on the Map
            var marker = new google.maps.Marker({
                position: myAddress
            });
            marker.setMap(map);
        }

        geocoder = new google.maps.Geocoder();

        google.maps.event.addDomListener(window, 'load', function () {
        var places = new google.maps.places.Autocomplete(document.getElementById('startLocation'));
           // var endplace = new google.maps.places.Autocomplete(document.getElementById('endLocation'));
            google.maps.event.addListener(places, 'place_changed', function () {
                var place = places.getPlace();
                document.getElementById('startLocation').value = place.formatted_address;
               // document.getElementById('endLocation').value = place.formatted_address;

               geocodeAddress(place.formatted_address);
            });
        });

        function geocodeAddress(address) {
            geocoder.geocode({ address: address }, (results, status) => {
                if(status == "OK") {
                    const location = results[0].geometry.location;

                    //update map
                var mapOptions = {
                        center: location,
                        zoom: 15,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                var map = new google.maps.Map(document.getElementById("map"), mapOptions);

                var marker = new google.maps.Marker({
                    position: location
                });
                marker.setMap(map);

                    console.log("Geocoded Location:", {
                    address: results[0].formatted_address,
                    latitude: location.lat(),
                    longitude: location.lng(),
                    });

                    // Optionally send the geocoded data to your backend
                   // submitLocation({
                   // address: results[0].formatted_address,
                    //latitude: location.lat(),
                   // longitude: location.lng(),
                   // });
                } else {
                    alert("Geocoding failed: " + status);
                }
            });
        }

        function submitLocation(locationData) {
            fetch('/Map/SaveLocation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(locationData),
            })
            .then(response => response.json())
            .then(data => {
                console.log("Location saved successfully:", data);
                alert("Location submitted successfully!");
            })
            .catch(error => {
                console.error("Error submitting location:", error);
                alert("Failed to submit the location. Please try again.");
            });
        }
        window.onload = InitializeMap;
    </script>
    @if (ViewBag.Message != null)
    {
        <script type="text/javascript">
            window.onload = function(){
                alert("@ViewBag.Message");
            };
        </script>
    }
</body>
</html>
